# 리액트 쿼리

## **SWR (stale-while-revalidate)**

- 캐싱된 컨텐츠를 즉시 로드하는 즉시성
- 업데이트된 캐싱 컨텐츠를 미래에 사용하도록 보장하기 위한 디렉티브(DOM의 모든 것을 관리하기 위한 지시)
  브라우저는 max-age 에 따라 캐싱된 컨텐츠의 최신 상태 여부를 판단한다.
  http 헤더가 `Cache-Control: max-age=1, stale-while-revalidate=59` 일 경우,
- HTTP 요청이 1초(max-age) 이내에 반복적으로 발생 -> 유효성 검증 없이 캐싱된 콘텐츠 반환
- HTTP 요청이 1~60초(max-age ~ swr) 사이에 반복적으로 발생 -> 미리 캐싱된 컨텐츠 반환과 동시에 새로운 컨텐츠 재검증 요청
- HTTP 요청이 60초(swr ~) 이후 발생 -> 서버로 요청하여 컨텐츠 반환
  출처: https://youthfulhps.dev/web/stale-while-ravalidate/#stale-while-revalidate

## 리액트 쿼리

서버 상태를 가져와서 캐싱, 동기화, 업데이트를 쉽게 처리.
클라이언트와 서버의 상태 값을 일치 시켜야하는 경우에서 발생하는 부가적인 로직들을 리액트 쿼리 인터페이스로 간편하게 처리할 수 있음
출처 : https://velog.io/@jay/10-minute-react-query-concept

- 특정 시간 이후 데이터를 다시 요청(유효하지 않은 경우로 판단)
- 데이터가 변경되었을 경우 리렌더링 유발
- 유효한 데이터를 다시 불러올 때 (탭A -> 탭B -> 탭A 돌아오는 경우)
  **유효한 데이터는 그대로 사용하고, 정해진 기간이 지나 유효하지 않다고 판단할 경우에만 새로운 데이터를 요청하고 리렌더링 하도록 도와줌**

## UI / Server State 분리하는 이유

클라이언트가 자체적으로 만드는 state(대부분 UI): 다크모드/라이트모드, 모달 상태 등..
클라이언트로 가져온 서버 state: 컴포넌트 생명주기에 따라 ajax 호출....
앱이 고도화되며 성능 향상 필요...
주식, 코인 거래소와 같이 실시간성이 중요한 경우 서버 상태를 주기적으로 / 서버 상태가 바뀌면 클라이언트에 반영해야한다.

## isFetching / isLoading 차이

isFetching은 비동기 쿼리가 아직 해결되지 않았음을 의미한다.
isLoading은 쿼리 함수가 아직 해결되지 않았음을 의미한다. 캐시된 데이터도 없다. 표시할 캐시 데이터도 없다는 것.
페이지네이션을 구현할 때 캐시된 데이터가 있느냐, 없느냐를 구분하게 된다.
isFetching axync 쿼리 함수가 해결되지 않음(데이터 가져오는 중). 캐시된 데이터 존재 여부와 상관 없음.
isLoading isFetching 트루 && 쿼리에 대해 캐시된 데이터가 없는 상태
ex. prefetching 으로 다음 데이터를 미리 캐싱해 두어도 isFetching으로 상태를 구분하면 isLoading과 다르게 작동한다.

### isError

리액트 쿼리는 기본 3번 시도한 후에 에러를 판정한다.

### error

에러를 처리할 때 사용할 수 있다.

## Stale Data

데이터 리페칭은 만료된 데이터에서만 실행된다. 데이터 만료 말고도 컴포넌트가 마운트되거나 윈도우가 다시 포커스되었을 때 리페칭이 실행된다. 하지만, 필수적으로 데이터가 만료되어야한다. stleTime은 데이터의 만료 시간을 결정한다.
staleTime은 useQuery의 세번째 인수로 전달하여 조정할 수 있다.
stale은 리페칭 고려 사항. 캐시는 나중에 필요할 수도 있는데이터 내용.

**StaleTime / CacheTime**
StaleTime: 쿼리가 fresh에서 stale로 전환될 때까지 유효 기간. 최신 쿼리라면 데이터는 항상 캐시에서만 가져오고 네트워크 요청이 발생하지 않는다. 그러나 쿼리가 오래된 경우 캐시에서 데이터를 가져오지만 특정 상황에서는 백그라운드에서 re-fetch가 발생할 수 있다.
CacheTime: 비활성 쿼리가 캐시에서 제거될 때까지의 시산. 기본 값은 5분. 쿼리는 등록된 관찰자가 없으면 즉시 비활성 상태로 전환되므로 해당 쿼리를 사용하는 모든 구성요소가 언마운트 된다.

출처: https://parang.gatsbyjs.io/react/2022-react-01/

## Mutaion

서버에 데이터를 업데이트하도록 서버에 네트워크 호출함.

## 쿼리 키

쿼리키 배열을 의존성 배열로 이해하자

캐시, 쿼리 키 이해하기
페칭
